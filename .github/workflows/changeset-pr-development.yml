name: Deploy Frontend to Development

on:
    push:
        branches: ["main"]
        paths:
            - "frontend/**"
            - ".changeset/**"
            - "k8s/**"

permissions:
    contents: write
    actions: read

jobs:
    build_and_deploy:
        runs-on: ubuntu-latest
        name: Build and Deploy Frontend to Dev

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "20"

            - name: Install root dependencies
              run: npm install

            - name: Install frontend dependencies
              run: npm install
              working-directory: frontend

            - name: Read version from frontend package.json
              id: get-version
              run: |
                  VERSION=$(node -p "require('./frontend/package.json').version")
                  echo "FRONTEND_VERSION=$VERSION" >> $GITHUB_ENV

            - name: Clean previous Next.js output
              run: rm -rf .next || true
              working-directory: frontend

            - name: Login to Docker Hub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKER_HUB_USERNAME }}
                  password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

            - name: Build frontend
              run: npm run build
              working-directory: frontend

            - name: Build frontend docker image
              run: |
                  IMAGE_URI=${{ secrets.FRONTEND_IMAGE }}:${{ env.FRONTEND_VERSION }}
                  echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

                  docker build \
                    -t $IMAGE_URI \
                    ./frontend \
                    --build-arg NEXT_PUBLIC_API_KEY=${{ secrets.NEXT_PUBLIC_API_KEY }} \
                    --build-arg NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}

            - name: Push docker image
              run: docker push $IMAGE_URI

            - name: Zip build output
              run: |
                  zip -r ../frontend-${{ env.FRONTEND_VERSION }}.zip . \
                    -x "node_modules/*" -x ".next/cache/*"
              working-directory: frontend

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: frontend-${{ env.FRONTEND_VERSION }}
                  path: frontend-${{ env.FRONTEND_VERSION }}.zip

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ env.FRONTEND_VERSION }}
                  name: Frontend Release ${{ env.FRONTEND_VERSION }}
                  files: frontend-${{ env.FRONTEND_VERSION }}.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Update ArgoCD patch with new image
              run: |
                  IMAGE_URI=${{ secrets.FRONTEND_IMAGE }}:${{ env.FRONTEND_VERSION }}

                  env IMAGE_URI="$IMAGE_URI" envsubst < k8s/overlays/dev/frontend-image-patch.yaml \
                    > k8s/overlays/dev/frontend-image-patch.tmp.yaml

                  mv k8s/overlays/dev/frontend-image-patch.tmp.yaml \
                    k8s/overlays/dev/frontend-image-patch.yaml

                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"

                  git add k8s/overlays/dev/frontend-image-patch.yaml
                  git commit -m "chore: update frontend image to $IMAGE_URI [skip ci]" || echo "No changes to commit"
                  git push origin main || echo "No changes to push"
